<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//RU"  
  "http://www.w3.org/TR/html4/loose.dtd">  
<html > 
<head><title>Дополнительные возможности</title> 
<meta http-equiv="Content-Type" content="text/html; charset=utf-8"> 
<meta name="generator" content="TeX4ht (http://www.cse.ohio-state.edu/~gurari/TeX4ht/)"> 
<meta name="originator" content="TeX4ht (http://www.cse.ohio-state.edu/~gurari/TeX4ht/)"> 
<!-- 3,next,fn-in,charset=utf-8,sections+,minitoc<,html --> 
<meta name="src" content="clm.tex"> 
<meta name="date" content="2013-03-12 14:38:00"> 
<link rel="stylesheet" type="text/css" href="clm.css"> 
<link rel="stylesheet" type="text/css" href="../cltl2ed.css"></head><body 
>
   <div id="toplinks"> &lt;<a href="../index.html">Главная</a>&gt; &lt;<a href="symbols.html">Символы</a>&gt; <br />&#x003C;<a 
href="pprint.html" >Далее</a>&#x003E;&#x003C;<a 
href="clmse146.html" >Назад</a>&#x003E;&#x003C;<a 
href="clmse146.html#tailclmse146.html" >Назад-и-вниз</a>&#x003E;&#x003C;<a 
href="#tailclmse147.html">В-конец</a>&#x003E;&#x003C;<a 
href="clmch26.html#clmse147.html" >Наверх</a>&#x003E;</div><h3 class="sectionHead"><span class="titlemark">26.23
</span> <a 
href="clm.html#QQ2-178-297" id="x178-25600026.23">Дополнительные возможности</a></h3>
<!--l. 2460--><p class="noindent" >The Loop Facility provides the <b><a 
href="symbols.html#x200-396663r663">named</a></b> construct to name a loop so that the
Common Lisp special operator <b><a 
href="symbols.html#x200-396817r817">return-from</a></b> can be used.
<!--l. 2463--><p class="indent" >   Для задания имени цикла используется конструкция <b><a 
href="symbols.html#x200-396663r663">named</a></b>. Данное имя
впоследствии можно использовать в <b><a 
href="symbols.html#x200-396817r817">return-from</a></b>.
<!--l. 2466--><p class="indent" >   The loop keywords <b><a 
href="symbols.html#x200-396496r496">initially</a></b> and <b><a 
href="symbols.html#x200-396412r412">ﬁnally</a></b> designate loop constructs
that cause expressions to be evaluated before and after the loop body,
respectively.
<!--l. 2469--><p class="indent" >   Символы <b><a 
href="symbols.html#x200-396496r496">initially</a></b> и <b><a 
href="symbols.html#x200-396412r412">ﬁnally</a></b> обозначают выражения, которые будут
выполнены перед и после тела цикла соответственно.
<!--l. 2472--><p class="indent" >   The code for any <b><a 
href="symbols.html#x200-396496r496">initially</a></b> clauses is collected into one <b><a 
href="symbols.html#x200-396761r761">progn</a></b> in the order in
which the clauses appeared in the loop. The collected code is executed once in the
loop prologue after any implicit variable initializations.
<!--l. 2477--><p class="indent" >   Выражения после всех <b><a 
href="symbols.html#x200-396496r496">initially</a></b> собираются в один <b><a 
href="symbols.html#x200-396761r761">progn</a></b> в исходном
порядке. Сгруппированный код выполняется единожды перед началом
итераций.
<!--l. 2481--><p class="indent" >   The code for any <b><a 
href="symbols.html#x200-396412r412">ﬁnally</a></b> clauses is collected into one <b><a 
href="symbols.html#x200-396761r761">progn</a></b> in the order in
which the clauses appeared in the loop. The collected code is executed once in the
loop epilogue before any implicit values are returned from the accumulation
clauses. Explicit returns in the loop body, however, will exit the loop without
executing the epilogue code.
<!--l. 2488--><p class="indent" >   Выражения после всех <b><a 
href="symbols.html#x200-396412r412">ﬁnally</a></b> собираются в один <b><a 
href="symbols.html#x200-396761r761">progn</a></b> в исходном
порядке. Сгруппированный код выполняется единожды после выполнения
всех итераций в эпилоге перед неявным возвратом значений. В случае явного
выхода из цикла, эпилог не выполняется.
<!--l. 2493--><p class="noindent" >
   <h4 class="subsectionHead"><span class="titlemark">26.23.1   </span> <a 
href="frontmatter.html#QQ2-178-298" id="x178-25700026.23.1">Data Types</a></h4>
                                                                          

                                                                          
<!--l. 2496--><p class="noindent" >
   <h4 class="subsectionHead"><span class="titlemark">26.23.2   </span> <a 
href="frontmatter.html#QQ2-178-299" id="x178-25800026.23.2">Типы данных</a></h4>
<!--l. 2499--><p class="noindent" >Many loop constructs take a <em>type-spec</em> argument that allows you to specify certain
data types for loop variables. While it is not necessary to specify a data type for
any variable, by doing so you ensure that the variable has a correctly typed initial
value. The type declaration is made available to the compiler for more eﬃcient
<b><a 
href="symbols.html#x200-396577r577">loop</a></b> expansion. In some implementations, ﬁxnum and ﬂoat declarations
are especially useful; the compiler notices them and emits more eﬃcient
code.
<!--l. 2510--><p class="indent" >   Многие конструкции принимают аргумент <em>type-spec</em>, который позволяет
задать тип для переменной. Конечно в этом нет прямой необходимости, но
декларации типов упрощают дальнейшую работу с программой. Декларация
типов также помогает компилятору оптимизировать программу. Особенно это
касается типов ﬁxnum и ﬂoat.
<!--l. 2516--><p class="indent" >   The <em>type-spec</em> argument has the following syntax: <div class="tabbing">
<em>type-spec</em> ::= <b>of-type</b> <em>d-type-spec</em>
   <br>               <em>d-type-spec</em> ::= <em>type-speciﬁer</em> | <b>(<em>d-type-spec</em> . <em>d-type-spec</em>)</b><br>
<!--l. 2520--><p class="noindent" ></div>A <em> type-speciﬁer</em> in this syntax can be any Common Lisp type speciﬁer. The
<em>d-type-spec</em> argument is used for destructuring, as described in section <a 
href="#x178-25900026.23.3">26.23.3<!--tex4ht:ref: LOOP-DESTRUCTURING-SECTION --></a>. If
the <em>d-type-spec</em> argument consists solely of the types <b>ﬁxnum</b>, <b><a 
href="symbols.html#x200-396426r426">ﬂoat</a></b>, <b><a 
href="symbols.html#x200-396951r951">t</a></b>, or <b><a 
href="symbols.html#x200-396670r670">nil</a></b>, the
<b>of-type</b> keyword is optional. The <b>of-type</b> construct is optional in these cases to
provide backward compatibility; thus the following two expressions are the same:
<div class="lisp"><tt><div class="tabbing">
;;; This expression uses the old syntax for type speciﬁers.
   <br>                                                      (loop for i ﬁxnum upfrom 3 ...)<br>
<br>                  ;;; This expression uses the new syntax for type speciﬁers.<br>
(loop for i of-type ﬁxnum upfrom 3 ...)<br>
<!--l. 2534--><p class="noindent" ></div>
</tt>
</div>
<!--l. 2536--><p class="indent" >   Аргумент <em>type-spec</em> выглядит так: <div class="tabbing">
                                                                          

                                                                          
<em>type-spec</em> ::= <b>of-type</b> <em>d-type-spec</em>
   <br>               <em>d-type-spec</em> ::= <em>type-speciﬁer</em> | <b>(<em>d-type-spec</em> . <em>d-type-spec</em>)</b><br>
<!--l. 2540--><p class="noindent" ></div>На месте <em>type-speciﬁer</em> может быть любой спецификатор типа. Аргумент <em>d-type-spec</em>
используется для деструктуризации, как написано в разделе <a 
href="#x178-25900026.23.3">26.23.3<!--tex4ht:ref: LOOP-DESTRUCTURING-SECTION --></a>. Если
аргумент <em>d-type-spec</em> состоит только из ключевых слов <b>ﬁxnum</b>, <b><a 
href="symbols.html#x200-396426r426">ﬂoat</a></b>, <b><a 
href="symbols.html#x200-396951r951">t</a></b>
или <b><a 
href="symbols.html#x200-396670r670">nil</a></b>, символ <b>of-type</b> необязателен. Это оставлено для обратной
совместимости.
<div class="lisp">
<tt>
<!--l. 2548--><p class="indent" >   <div class="tabbing">
;;; Старый стиль кода.
   <br>                                                      (loop for i ﬁxnum upfrom 3 ...)<br>
<br>                                                    ;;; Новый стиль кода.<br>
(loop for i of-type ﬁxnum upfrom 3 ...)<br>
<!--l. 2554--><p class="noindent" ></div>
</tt>
</div>
<!--l. 2556--><p class="noindent" >
   <h4 class="subsectionHead"><span class="titlemark">26.23.3   </span> <a 
href="frontmatter.html#QQ2-178-300" id="x178-25900026.23.3">Destructuring</a></h4>
<!--l. 2559--><p class="noindent" >Destructuring allows you to bind a set of variables to a corresponding set of values
anywhere that you can normally bind a value to a single variable. During <b><a 
href="symbols.html#x200-396577r577">loop</a></b>
expansion, each variable in the variable list is matched with the values in
the values list. If there are more variables in the variable list than there
are values in the values list, the remaining variables are given a value of
<b><a 
href="symbols.html#x200-396670r670">nil</a></b>. If there are more values than variables listed, the extra values are
discarded.
<!--l. 2567--><p class="indent" >   Suppose you want to assign values from a list to the variables <b>a</b>, <b>b</b>, and <b>c</b>. You
could use one <b><a 
href="symbols.html#x200-396436r436">for</a></b> clause to bind the variable <b>numlist</b> to the <em>car</em> of the speciﬁed
expression, and then you could use another <b><a 
href="symbols.html#x200-396436r436">for</a></b> clause to bind the variables <b>a</b>, <b>b</b>,
and <b>c</b> sequentially. <div class="lisp"><tt><div class="tabbing">
                                                                          

                                                                          
;;; Collect values by using FOR constructs.
   <br>                            (loop for numlist in &#x2019;((1 2 4.0) (5 6 8.3) (8 9 10.4))<br>
      for a integer = (ﬁrst numlist)<br>
      and for b integer = (second numlist)<br>
      and for c ﬂoat = (third numlist)<br>                collect (list c b a))<br>
   <span class="math"> ⇒</span> ((4.0 2 1) (8.3 6 5) (10.4 9 8))<br>
<!--l. 2580--><p class="noindent" ></div>
</tt>
</div>
<!--l. 2581--><p class="indent" >   Destructuring makes this process easier by allowing the variables to be bound
in parallel in each loop iteration. You can declare data types by using a
list of <em>type-spec</em> arguments. If all the types are the same, you can use a
shorthand destructuring syntax, as the second example following illustrates.
<div class="lisp"><tt><div class="tabbing">
;;; Destructuring simpliﬁes the process.
   <br>                                         (loop for (a b c) (integer integer ﬂoat) in<br>
      &#x2019;((1 2 4.0) (5 6 8.3) (8 9 10.4))<br>
      collect (list c b a)))<br>              <span class="math"> ⇒</span> ((4.0 2 1) (8.3 6 5) (10.4 9 8))<br>
<br>                   ;;; If all the types are the same, this way is even simpler.<br>
(loop for (a b c) ﬂoat in<br>         &#x2019;((1.0 2.0 4.0) (5.0 6.0 8.3) (8.0 9.0 10.4))<br>
      collect (list c b a))<br>     <span class="math"> ⇒</span> ((4.0 2.0 1.0) (8.3 6.0 5.0) (10.4 9.0 8.0))<br>
<!--l. 2598--><p class="noindent" ></div>
</tt>
</div>
<!--l. 2601--><p class="indent" >   If you use destructuring to declare or initialize a number of groups of variables
into types, you can use the loop keyword <b><a 
href="symbols.html#x200-396098r98">and</a></b> to simplify the process further.
<div class="lisp"><tt><div class="tabbing">
;;; Initialize and declare variables in parallel
                                                                          

                                                                          
   <br>                                                      ;;; by using the AND construct.<br>
(loop with (a b) ﬂoat = &#x2019;(1.0 2.0)<br>               and (c d) integer = &#x2019;(3 4)<br>
      and (e f)<br>                                  return (list a b c d e f))<br>
   <span class="math"> ⇒</span> (1.0 2.0 3 4 NIL NIL)<br>
<!--l. 2612--><p class="noindent" ></div>
</tt>
</div>
<!--l. 2614--><p class="indent" >   A data type speciﬁer for a destructuring pattern is a tree of type speciﬁers
with the same shape as the tree of variables, with the following exceptions:
      <ul class="itemize1">
      <li class="itemize">When aligning the trees, an atom in the type speciﬁer tree that matches
      a cons in the variable tree declares the same type for each variable.
      </li>
      <li class="itemize">A cons in the type speciﬁer tree that matches an atom in the variable
      tree is a non-atomic type specifer.
      </li></ul>
<div class="lisp">
<tt>
<!--l. 2629--><p class="indent" >   <div class="tabbing">
;;; Declare X and Y to be of type VECTOR and FIXNUM, respectively.
   <br>                      (loop for (x y) of-type (vector ﬁxnum) in my-list do ...)<br>
<!--l. 2632--><p class="noindent" ></div>
</tt>
</div>
<!--l. 2634--><p class="indent" >   If <b><a 
href="symbols.html#x200-396670r670">nil</a></b> is used in a destructuring list, no variable is provided for its place.
<div class="lisp"><tt><div class="tabbing">
(loop for (a nil b) = &#x2019;(1 2 3)
   <br>                                                               do (return (list a b)))<br>
   <span class="math"> ⇒</span> (1 3)<br>
                                                                          

                                                                          
<!--l. 2640--><p class="noindent" ></div>
</tt>
</div>
<!--l. 2642--><p class="indent" >   Note that nonstandard lists can specify destructuring. <div class="lisp"><tt><div class="tabbing">
(loop for (x . y) = &#x2019;(1 . 2)
   <br>                                  do (return y))<br>                               <span class="math"> ⇒</span> 2<br>
<br>                                                  (loop for ((a . b) (c . d))<br>
          of-type ((ﬂoat . ﬂoat) (integer . integer))<br>
          in &#x2019;(((1.2 . 2.4) (3 . 4)) ((3.4 . 4.6) (5 . 6)))<br>
      collect (list a b c d))<br>                <span class="math"> ⇒</span> ((1.2 2.4 3 4) (3.4 4.6 5 6))<br>
<!--l. 2653--><p class="noindent" ></div>
</tt>
</div>
<!--l. 2655--><p class="indent" >   [It is worth noting that the destructuring facility of <b><a 
href="symbols.html#x200-396577r577">loop</a></b> predates, and diﬀers
in some details from, that of <b><a 
href="symbols.html#x200-396339r339">destructuring-bind</a></b>, an extension that has been
provided by many implementors of Common Lisp.—GLS]
<div class="defloop">
<div class="defmacheader">
<!--l. 2661--><p class="indent" >   <div class="tabbing">
 <em>[Выражение цикла]</em> <b>initially</b> <a 
 id="dx178-259001"></a>{expr}*
   <br>
<!--l. 2661--><p class="noindent" ></div>
</div>
<div class="defmacheader">
<!--l. 2661--><p class="indent" >   <div class="tabbing">
 <em>[Выражение цикла]</em> <b>ﬁnally</b> <a 
 id="dx178-259002"></a>[<b>do</b> | <b>doing</b>] {expr}*
   <br>
<!--l. 2662--><p class="noindent" ></div>
</div>
<div class="defmacheader">
                                                                          

                                                                          
<!--l. 2662--><p class="indent" >   <div class="tabbing">
 <em>[Выражение цикла]</em> <b>ﬁnally</b> <a 
 id="dx178-259003"></a><b>return</b> expr
   <br>
<!--l. 2664--><p class="noindent" ></div>
</div>
<!--l. 2665--><p class="indent" >   The <b><a 
href="symbols.html#x200-396496r496">initially</a></b> construct causes the speciﬁed expression to be evaluated in the
loop prologue, which precedes all loop code except for initial settings speciﬁed by
constructs <b><a 
href="symbols.html#x200-397012r1012">with</a></b>, <b><a 
href="symbols.html#x200-396436r436">for</a></b>, or <b><a 
href="symbols.html#x200-396123r123">as</a></b>. The <b><a 
href="symbols.html#x200-396412r412">ﬁnally</a></b> construct causes the speciﬁed
expression to be evaluated in the loop epilogue after normal iteration
terminates.
<!--l. 2672--><p class="indent" >   The <em>expr</em> argument can be any non-atomic Common Lisp form.
<!--l. 2674--><p class="indent" >   Clauses such as <b><a 
href="symbols.html#x200-396816r816">return</a></b>, <b><a 
href="symbols.html#x200-396097r97">always</a></b>, <b><a 
href="symbols.html#x200-396668r668">never</a></b>, and <b><a 
href="symbols.html#x200-396959r959">thereis</a></b> can bypass the <b><a 
href="symbols.html#x200-396412r412">ﬁnally</a></b>
clause.
<!--l. 2677--><p class="indent" >   The Common Lisp macro <b><a 
href="symbols.html#x200-396816r816">return</a></b> (or the <b><a 
href="symbols.html#x200-396816r816">return</a></b> loop construct) can be
used after <b><a 
href="symbols.html#x200-396412r412">ﬁnally</a></b> to return values from a loop. The evaluation of the
<b><a 
href="symbols.html#x200-396816r816">return</a></b> form inside the <b><a 
href="symbols.html#x200-396412r412">ﬁnally</a></b> clause takes precedence over returning the
accumulation from clauses speciﬁed by such keywords as <b><a 
href="symbols.html#x200-396257r257">collect</a></b>, <b><a 
href="symbols.html#x200-396666r666">nconc</a></b>,
<b><a 
href="symbols.html#x200-396099r99">append</a></b>, <b><a 
href="symbols.html#x200-396939r939">sum</a></b>, <b><a 
href="symbols.html#x200-396299r299">count</a></b>, <b><a 
href="symbols.html#x200-396625r625">maximize</a></b>, and <b><a 
href="symbols.html#x200-396639r639">minimize</a></b>; the accumulation values
for these pre-empted clauses are not returned by the loop if <b><a 
href="symbols.html#x200-396816r816">return</a></b> is
used.
<!--l. 2686--><p class="indent" >   The constructs <b><a 
href="symbols.html#x200-396347r347">do</a></b>, <b><a 
href="symbols.html#x200-396496r496">initially</a></b>, and <b><a 
href="symbols.html#x200-396412r412">ﬁnally</a></b> are the only loop keywords that take
an arbitrary number of (non-atomic) forms and group them as if by using an
implicit <b><a 
href="symbols.html#x200-396761r761">progn</a></b>.
<!--l. 2692--><p class="indent" >   Examples: <div class="lisp"><tt><div class="tabbing">
;;; This example parses a simple printed string representation
   <br>                  ;;; from BUFFER (which is itself a string) and returns the<br>
;;; index of the closing double-quote character.<br>
<br>                         (loop initially (unless (char= (char buﬀer 0) #\&#x0022;)<br>
                  (loop-ﬁnish))<br>
      for i ﬁxnum from 1 below (string-length buﬀer)<br>
      when (char= (char buﬀer i) #\&#x0022;)<br>                         return i)<br>
<br>                          ;;; The FINALLY clause prints the last value of I.<br>
;;; The collected value is returned.<br>         <br>            (loop for i from 1 to 10<br>
                                                                          

                                                                          
      when (&#x003E; i 5)<br>                                              collect i<br>
      ﬁnally (print i))                                       ;Prints 1 line<br>
11<br>                                                        <span class="math"> ⇒</span> (6 7 8 9 10)<br>
<br>                             ;;; Return both the count of collected numbers<br>
;;; as well as the numbers themselves.<br>                                      <br>
(loop for i from 1 to 10<br>                                      when (&#x003E; i 5)<br>
        collect i into number-list<br>         and count i into number-count<br>
      ﬁnally (return (values number-count number-list)))<br>
   <span class="math"> ⇒</span> 5 and (6 7 8 9 10)<br>
<!--l. 2723--><p class="noindent" ></div>
</tt>
</div>
<hr>
</div>
<div class="defloop">
<div class="defmacheader">
<!--l. 2727--><p class="indent" >   <div class="tabbing">
 <em>[Выражение цикла]</em> <b>named</b> <a 
 id="dx178-259004"></a>name
   <br>
<!--l. 2728--><p class="noindent" ></div>
</div>
<!--l. 2729--><p class="indent" >   The <b><a 
href="symbols.html#x200-396663r663">named</a></b> construct allows you to assign a name to a <b><a 
href="symbols.html#x200-396577r577">loop</a></b> construct so that
you can use the Common Lisp special operator <b><a 
href="symbols.html#x200-396817r817">return-from</a></b> to exit the named
loop.
<!--l. 2733--><p class="indent" >   Only one name may be assigned per loop; the speciﬁed name becomes the
name of the implicit block for the loop.
<!--l. 2736--><p class="indent" >   If used, the <b><a 
href="symbols.html#x200-396663r663">named</a></b> construct must be the ﬁrst clause in the loop expression,
coming right after the word <b><a 
href="symbols.html#x200-396577r577">loop</a></b>.
<!--l. 2740--><p class="indent" >   Example: <div class="lisp"><tt><div class="tabbing">
;;; Just name and return.
   <br>                                                                        (loop named max<br>
      for i from 1 to 10<br>                                      do (print i)<br>
                                                                          

                                                                          
      do (return-from max &#x2019;done))                           ;Prints 1 line<br>
1<br>                                                              <span class="math"> ⇒</span> DONE<br>
<!--l. 2749--><p class="noindent" ></div>
</tt>
</div>
<hr>
</div>
                                                                          

                                                                          
                                                                          

                                                                          
                                                                          

                                                                          
                                                                          

                                                                          
<!--l. 7--><p class="indent" >   <div id="bottomlinks">&#x003C;<a 
href="pprint.html" >Далее</a>&#x003E;&#x003C;<a 
href="clmse146.html" >Назад</a>&#x003E;&#x003C;<a 
href="clmse146.html#tailclmse146.html" >Назад-и-вниз</a>&#x003E;&#x003C;<a 
href="clmse147.html" >В-начало</a>&#x003E;&#x003C;<a 
href="clmch26.html#clmse147.html" >Наверх</a>&#x003E;<br> &lt;<a href="../index.html">Главная</a>&gt; &lt;<a href="symbols.html">Символы</a>&gt;</div><a 
 id="tailclmse147.html"></a>
 
</body></html> 
